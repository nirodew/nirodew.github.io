Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){function n(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}if(null===this)throw new TypeError('"this" is null or not defined');var o=Object(this),a=o.length>>>0;if(0===a)return!1;for(var i=0|t,l=Math.max(i>=0?i:a-Math.abs(i),0);a>l;){if(n(o[l],e))return!0;l++}return!1}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){return(void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e}}),String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),t+e.length>this.length?!1:-1!==this.indexOf(e,t)});var PREF=function(){function e(e,t,n){function o(e){var o=a[e],i=o.category,l=o.name,r=o.sketches,c=o.pages;if(i&&i[0]!==n&&"all"!==i[0]){if("none"===i[0])return"none"}else if("all"===l[0]||l.includes(t)){if(!r||r.includes(s)||r.includes(d)||"all"===r[0]){if("string"==typeof c){c=c.split(",");for(var u=0;u<c.length;u++)c[u]=c[u].trim()}return c}if("none"===r[0])return"none"}else if("none"===l[0])return"none"}var i,l,r=e.focusPage.anchorNode,s=r.context.id,c=r.data("url")||r.data("delayed-url")||"",d=c.match(/([\w\d_-]*)\.?[^\\\/]*$/i)[1];n||(n=""),n=n.toLowerCase(),t=t.toLowerCase(),l=e.getAuthorPreference(t+n);for(var u=0;u<a.length;u++)i=o(u),"none"===i?l=void 0:i&&(l=i);return l}function t(e,t,n){var o,a;if(!e)return[t];for(a=e.toLowerCase().split(","),o=0;o<a.length;o+=1)a[o]=a[o].trim();if(1===a.length&&["all","none"].includes(a[0]))return a;if(n)for(o=0;o<a.length;o+=1)a[o]=parseInt(a[o],10);return a}function n(e,n,o,a){try{this.category=t(e,"all"),"all"===this.category[0]&&(this.category=["widget, util"]),this.name=t(n,"all"),this.pages=t(a,"all",!0),this.sketches=t(o,"all")}catch(e){throw GSP.createError("bad arguments to WSPPref constructor")}}function o(e){var t,o;if(e.constructor===Array)for(var i=0;i<e.length;i++){var l=e[i];t=l.category?l.category:"widget, util",o=l.name?l.name:"all",l.widget&&(t="widget",o=l.widget),a.push(new n(t,o,l.sketches,l.pages))}}var a=[];return{setWebPagePrefs:function(e){o(e)},shouldEnableForCurrentPage:function(t,n,o){var a=parseInt(o.metadata.id,10),i=e(o.document,n,t);return"all"===i[0]||i.includes(a)},getPref:function(t,n,o){return e(t,n,o)}}}(),WIDGETS=function(){function e(e,t){return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t.prototype}function t(){return re?se.data("document").sQuery.sketch:void 0}function n(e){return $(e).closest(".sketch_canvas")[0]}function o(e){this.name=e,this.domButtonSelector="#widget_"+e+"ButtonID",this.enabled=!0}function a(e){o.call(this,e)}function i(){ie.tinyDraggable({exclude:".dragExclude"}),ie.toggle(!0),$(".widget_button").removeClass("widget_button_active"),se.parent().find(".widget_button").addClass("widget_button_active")}function l(){ie&&ie.toggle(!1),$(".widget_button").removeClass("widget_button_active")}function r(){var e,n=$(".sketch_canvas");Se.objectColorBox=$("#objectColorCheckbox")[0],Se.textColorBox=$("#textColorCheckbox")[0],n.on("LoadDocument.WSP",function(e,t){y(t.document.canvasNode[0]),v(t.document)}),n.on("UnloadDocument.WSP",function(e,n){ue&&t()===n.document.focusPage&&ue.deactivate()}),n.on("WillUndoRedo.WSP",m),n.on("UndoRedo.WSP",b),n.on("WillChangeCurrentPage.WSP",m),n.on("DidChangeCurrentPage.WSP",b),n.each(function(t,n){var o=$(n).data("document");y(n),o&&(v(o),e||(e=o))}),e&&b({},{document:e}),n.on("keyup",function(e){return 27===e.keyCode&&ue?(ue.deactivate(),!0):void 0})}function s(){var e=$(".wCharDropdownContent .column div");$._data(e[0],"events")||$(".wCharDropdownContent .column div").click(function(){Z(this.innerText)})}function c(e,o){var a=n(e),r=$(a),c=r.find(".wsp-tool-column"),d=r.data("document"),u=d.sQuery.sketch;if("none"===r.css("display")||u===ce)return ue;var f=!1;return Le.forEach(function(e){e.checkEnablingForCurrentPage(u)&&(f=!0)}),f?(ue&&(fe=ue,ue.deactivate()),Le.forEach(function(e){e.setEnablingForCurrentPage(u,e)}),(a!==re||o)&&(re&&(se.off("WillPlayTool.WSP"),se.off("ToolPlayed.WSP"),se.off("ToolAborted.WSP")),re=a,se=$(re),ce=u,le.detach(),r.prepend(le),s(),i(),ie.css({top:r.height()-ie.height()+1}),ie.css(c.length?{left:c[0].offsetWidth-ie[0].offsetWidth+4}:{left:-1}),se.on("WillPlayTool.WSP",function(){$("#widget").css({opacity:.25,"z-index":-1}),ue&&(fe=ue,WIDGETS.confirmModality())}),se.on("ToolPlayed.WSP",function(){$("#widget").css({opacity:1,"z-index":"none"}),fe&&(fe.activate(t()),fe=null)}),se.on("ToolAborted.WSP",function(){$("#widget").css({opacity:1,"z-index":"none"})})),Pe.setVisColor(u),fe&&fe.enabled&&fe.activate(u,fe),fe=null,f&&ue):(re&&a!==re||(fe||(fe=ue),ue&&ue.deactivate(),l()),!1)}function d(e){t()!==e&&c(e.canvasNode[0]),t()===e&&ue&&ue.preProcessGobj&&(e.sQuery("*").each(ue.preProcessGobj),e.isDirty=!0,e.setNeedsDisplay())}function u(e,n){var o=n?n.sketch:t();return d(o),!0}function f(){return ue&&ue.postProcessSketch(t()),!0}function p(){return parseFloat(getComputedStyle($("#widget")[0]).fontSize)/16}function h(e,t){e.checked=t,e.src=t?ae+"/checked.png":ae+"/unchecked.png"}function g(e){return e.checked=e.checked?!1:!0,e.src=e.checked?ae+"/checked.png":ae+"/unchecked.png",e.checked}function b(e,t){var n=t.document;c(n.canvasNode[0],!0);var o=n.canvasNode[0],a=re===o&&"none"!==ie[0].style.display,i=o.parentNode,l=$(i).find(".widget_button");a?l.show():l.hide()}function m(){ue&&(fe=ue,ue.deactivate())}function y(e){var t,n=e.parentNode,o=$(n).find(".widget_button");1===o.length&&(t='<button class="widget_button" onclick="WIDGETS.toggleWidgets(this);">Widgets</button>',o.replaceWith(t))}function v(e){var t,n,o,a;t=e.canvasNode,n=t.parent(),n.hasClass("sketch_container")&&(o=t.find(".wsp-base-node"),o||(o=t),a=parseInt(o.css("width"),10)+parseInt(n.css("border-left-width"),10)+parseInt(n.css("border-right-width"),10),a||(a=parseInt(t.find(".wsp-tool-column").css("width"),10),a=isNaN(a)?0:a+18,a+=e.metadata.width),n.css("width",a+"px"))}function w(e){de&&de&&de!==e&&(de.setRenderState("none"),de=null),e&&(de=e,de.setRenderState(pe))}function S(e,t){var n=se.find("[wsp-id='"+t.id+"']");n[0]&&(n.css({color:e}),n.find("*").css({color:e}))}function P(e,t){var n=!1,o=t||de;if(!o)return!1;if(o.isOfKind("Text"))n=o.style.color!==e,n&&(o.style.color=e);else if(o.isOfKind("Button"))n=o.style.label.color!==e,n&&(o.style.label.color=e);else if(o.style.label&&o.style.label.showLabel&&(n=o.style.label.color!==e))return o.style.label.color=e,o.sQuery.sketch.renderRefCon.label[o.id].color=e,!0;return n&&S(e,o),z(o),n}function k(){var e,t,n=de;if(n.oldStyle)if(n.isOfKind("Button")||n.isOfKind("Text"))e=n.isOfKind("Text")?n.oldStyle.color:n.oldStyle.label.color,t=n.isOfKind("Text")?n.style.color:n.style.label.color;else if(n.style.label&&n.style.label.showLabel)return n.sQuery.sketch.renderRefCon.label[n.id].color=n.style.label.color,void n.invalidateAppearance();e&&t!==e&&P(e)}function C(){var e,t=Math.floor(me/3);switch(me-3*t){case 0:e="a";break;case 1:e="b";break;case 2:e="c"}return $(".block"+t+e).css("background-color")}function L(e,t){var n=!1,o=t||de;return o&&Se.objectColorBox.checked&&(o.isOfKind("Text")?n=P(e,o):(o.setRenderState("none"),n=o.style.color!==e,n&&(o.style.color=e,o.invalidateAppearance()),o.setRenderState(pe))),n}function T(e){var t=de;he=e,t&&t.style.radius&&he>=0&&(t.setRenderState("none"),t.style.radius=ye[he],t.setRenderState(pe),t.invalidateAppearance())}function O(e,t){var n=de;be=e,ge=t,n&&(n.setRenderState("none"),n.isOfGenus("Path")&&be>=0&&(n.style["line-style"]=ve[be]),n.style.width&&ge>=0&&(n.style.width=we[ge]),n.setRenderState(pe),n.invalidateAppearance())}function x(e){var t=C(e);Se.objectColorBox.checked&&L(t),Se.textColorBox.checked&&P(t)}function E(e,t){var n=$("#lineStyleCheckbox")[0],o=$("#widget_lineStyleSelector")[0].style;if(0>e&&0>t)h(n,!1),o.display="none";else{Se.defaultLineThickness=e,Se.defaultLineStyle=t,h(n,!0);var a=1.25*e+1.31,i=3.2*t+.31;o.top=a+"rem",o.left=i+"rem",o.display="block"}O(t,e)}function F(e){var t=$("#pointStyleCheckbox")[0],n=$("#pointStyleSelector")[0].style;if(0>e)h(t,!1),n.display="none";else{Se.defaultPointStyle=e,h(t,!0);var o=1.25*e+1.31;n.top=o+"rem",n.display="block"}T(e)}function j(e,t){var n=$("#widget_colorSelector")[0].style;0>e?(n.display="none",h(Se.objectColorBox,!1),h(Se.textColorBox,!1),me=-1):(me=3*e+t,n.top=1.56*t+.13+"rem",n.left=1.69*e+.1+"rem",n.display="block",Se.defaultColor={row:t,column:e},Se.textColorBox.checked||h(Se.objectColorBox,!0),de&&x(me))}function B(e){var t=e.style;t.originalColor=t.color,t.label&&t.label.color&&(t.label.originalColor=t.label.color)}function R(e){var t=e.style;if(t.faded)throw GSP.createError("visibilityWidget deleteFadeCache() called for a faded object.");t.originalColor&&(delete t.originalColor,t.label&&t.label.color&&delete t.label.originalColor,delete t.faded)}function W(e){var t=e.style;if(t.faded)throw GSP.createError("visibilityWidget fade() called for an already-faded object.");e.style.originalColor||B(e),t.faded||(t.color=Pe.visColor,t.label&&t.label.color&&(t.label.color=Pe.visColor),S(t.color,e),t.faded=!0,e.invalidateAppearance())}function G(e){var t=e.style;if(!t.originalColor||!t.faded)throw GSP.createError("visibilityWidget unfade() called for an object that isn't faded.");t.color=t.originalColor,t.label&&t.label.color&&(t.label.color=t.label.originalColor),S(t.color,e),t.faded=!1,e.invalidateAppearance()}function _(){t().labelPool.saveState(),ke.labelPoolSaved=!0}function N(){ke.labelPoolSaved&&(t().labelPool.restoreSavedState(),ke.labelPoolSaved=!1)}function D(){ke.labelPoolSaved&&(de.sQuery.sketch.labelPool.forgetSavedState(),ke.labelPoolSaved=!1)}function M(e){var t=ke.inputElt;"string"==typeof e&&t.val(e),t.focus(),t[0].setSelectionRange(0,t.val().length)}function I(e){var n;_(),n=t().labelPool.generateLabel(e.kind,e.genus),e.hasLabel?e.setLabel(n,{showLabel:!0,wasUserInitiated:!0}):e.label=n,M(n)}function A(e){var t=e.sQuery.sketch,n=X(e),o=n["font-family"];return"number"==typeof o&&(o>=t.document.resources.fontList.length&&(o=0),o=t.document.resources.fontList[o],n["font-family"]=o),o}function U(e){var t="";return e.genus.includes("Measure")?t="measure":e.genus.includes("Parameter")?t="param":e.useTransformLabel&&e.useTransformLabel()&&(t="transImage"),t}function z(e){var t,n,o=se.find("[wsp-id='"+e.id+"']"),a=X(e)["font-family"],i=X(e)["font-size"],l=X(e).color,r=e.sQuery.sketch,s=r.renderRefCon,c=e.hasLabel?s.label[e.id]:s.gobj[e.id];e.parsedMFS=null,e.hasLabel?(Q(c,"invalidateLabel passed a labeled gobj with no renderRefCon.label"),c["font-family"]=a,c["font-size"]=i,n=s.labelBounds[e.id],n&&r.invalidateRect(n),e.state.labelPreRenderJITPrepareDone=!1,e.labelPreRenderJITPrepare(r.dcForGObjLabel(e,"normal"),r.renderRefCon.label[e.id])):(t=c.css,c=c.baseStyles,Q(1===o.length,"invalidateLabel should find a single matching node."),t["font-family"]=a,t["font-size"]=i,t.color=l,c["font-family"]=a,c["font-size"]=i,c.color=l,o.css({"font-size":i,"font-family":a}),$(o).find('[style*="font-family"]').css("font-family",a),e.state.forceDomParse=!0,e.descendantLabelGraphHasChanged(),ke.showLabelElt.prop("checked","noVisibleName"!==e.style.nameOrigin)),e.invalidateAppearance()}function K(e,t){function n(){Q(!t,"A button or function shouldn't have a nameOrigin."),a.shouldAutogenerateLabel&&(a.shouldAutogenerateLabel=!1),i&&(e=" ",M(e)),a.label=e,a.messages&&(a.messages=[])}function o(){a.label=e,e=e.replace(/'/g,"\\'"),a.textMFS="<VL<T'"+e+"'>>"}var a=de,i=!e||""===e,l=void 0===a.style.nameOrigin||t===a.style.nameOrigin;return e||(e=""),de.label===e&&l?e:(i&&N(),t&&(a.style.nameOrigin=t),a.hasLabel?(a.shouldAutogenerateLabel=["namedByPrime","namedByShortFn","namedByFullFn","namedFromTemplate"].includes(t),i&&(e=a.label),a.setLabel(e,{showLabel:i?!1:!0}),ke.showLabelElt[0].checked=i?!1:!0,e=a.label):a.isOfKind("Button")||a.isOfGenus("Function")?n():"Caption"===a.genus?o():"namedFromLabel"===t&&(i?(I(a),e=a.label):a.label=e),z(a),e)}function V(){$("#wLabelPrompt").css("display","none"),$("#wLabelPane").css("display","block")}function Q(e,t){e||t||(t="Unidentified error")}function J(e){var t=de,n={},o=ke.touchPos,a=t.style.label,i=a&&a.showLabel;t.hasLabel&&!t.label&&I(t),void 0===e&&(t.hasLabel?e=!a.showLabel:ke.nameClass&&t.style.nameOrigin&&(e="noVisibleName"!==t.style.nameOrigin)),t.hasLabel?(a.showLabel=e,e&&!i&&(t.isAPath()&&(t.labelRenderBounds||(t.labelRenderBounds=H(t.sQuery.sketch.renderRefCon.labelBounds[t.id])),ke.isTap&&(n.x=o.x-t.labelRenderBounds.left,n.y=o.y-t.labelRenderBounds.top)),ke.isTap&&(a.labelOffsetX?(console.log("x="+a.labelOffsetX+"   y="+a.labelOffsetY),n={x:-a.labelOffsetX+o.x-t.labelSpec.location.x,y:-a.labelOffsetY+o.y-t.labelSpec.location.y}):n={x:a["font-size"],y:+a["font-size"]/2},t.setLabelPosition(o,n)),""===ke.inputElt[0].innerText&&M(t.label))):ke.nameClass&&t.style.nameOrigin&&LabelControls.labelChanged(e?t.label:""),ke.showLabelElt.prop("checked",e),z(t)}function H(e,t){return t||(t={}),t.top=e.top,t.bottom=e.bottom,t.left=e.left,t.right=e.right,t}function X(e){var t=e.style.label;return(!t||$.isEmptyObject(t))&&(t=e.style),t}function Y(e){var t,n=A(e);return t=n.substring(0,1),'"'===t||"'"===t?n=n.split(t)[1]:n.indexOf(",")&&(n=n.split(",")[0]),n}function q(){var e,t,n,o=$.makeArray($("script[src]"));for(e=0;e<o.length;e++)if(t=o[e],t.src&&t.src.endsWith("/widgets.js"))return n=t.src.split("?")[0].split("/").slice(0,-1).join("/")+"/"}function Z(e){var t="",n="",o=ke.inputElt[0],a=o.selectionStart,i=o.selectionEnd,l=o.value;a>0&&(t=l.slice(0,a)),i<l.length&&(n=l.slice(i)),l=t+e+n,WIDGETS.labelChanged(l),o.value=l,i=t.length+e.length,o.focus(),o.setSelectionRange(i,i)}function ee(e){return!(e.isOfKind("Text")||e.isOfKind("AngleMarker")||e.isOfKind("PathMarker")||e.isOfKind("Button")||e.isOfKind("CoordSys")||e.isOfKind("DOMKind")||e.isOfKind("IterateImage")||e.isOfKind("Map")||e.isOfKind("Picture"))}function te(){se.off("StartDrag.WSP"),se.off("EndDrag.WSP"),se.off("StartAnimate.WSP"),se.off("EndAnimate.WSP"),se.off("StartMove.WSP"),se.off("EndMove.WSP")}function ne(e,t){$.each(e,function(e,n){n.setRenderState(t)})}function oe(e){function t(e){n[e.id]&&alert("addGobj in deleteWidget called for an already-listed gobj!"),n[e.id]=e,e.setRenderState("targetHighlit"),e.children.forEach(function(e){n[e.id]||t(e)})}var n={};t(e),Ce.progenyList=n}var ae,ie,le,re,se,ce,de,ue,fe,pe="fadeInOut",he=-1,ge=-1,be=-1,me=-1,ye=[1.5,2,4,6],ve=["solid","dashed","dotted"],we=[.5,1,3,5];o.prototype.activate=function(e,t){return ue&&ue!==t&&ue.deactivate(),e.document.isCurrentlyInToolplay()?!1:(ue=t,this.active=!0,this.sketch=e,$(t.domButtonSelector).addClass("widget_active"),$(".widgetPane").on("keyup",function(e){27===e.keyCode&&ue.deactivate()}),!0)},o.prototype.deactivate=function(e){e===ue&&(ue=null),this.active=!1,this.sketch=null,$(e.domButtonSelector).removeClass("widget_active"),$(".widgetPane").off("keyup")},o.prototype.toggle=function(e,t){this===ue?this.deactivate(t):this.activate(e,t)},o.prototype.checkEnablingForCurrentPage=function(e){var t;return t=PREF.shouldEnableForCurrentPage("widget",this.name,e),"trace"===this.name&&(t=t&&e.preferences.tracesEnabled),t},o.prototype.setEnablingForCurrentPage=function(e,t){var n=this.checkEnablingForCurrentPage(e);return t.enabled=n,n?$(t.domButtonSelector).show():(this===ue&&t.deactivate(),ie.find(t.domButtonSelector).hide()),n},e(a,o),a.prototype.preProcessGobj=function(e,t){},a.prototype.postProcessGobj=function(e,t){},a.prototype.activate=function(e,t){var n=$(".sketch_canvas"),o=e.hasTouchRegimes()&&e.currentTouchRegime();return Object.getPrototypeOf(this).activate(e,t)?(n=$(".sketch_canvas"),n.on("Tap.WSP",t.handleTap),o&&"DisplayRegime"===o.name&&o.allowUnselectableTap(!0),d(e),!0):!1},a.prototype.deactivate=function(e){var n=t(),o=$(".sketch_canvas"),a=n.hasTouchRegimes()&&n.currentTouchRegime();o.off("Tap.WSP",e.handleTap),o.off("WillUndoRedo.WSP",f),o.off("UndoRedo.WSP",u),ue&&ue.postProcessSketch(this.sketch),a&&"DisplayRegime"===a.name&&a.allowUnselectableTap(!1),Object.getPrototypeOf(this).deactivate(e)},a.prototype.handleTap=function(e,t){var o=n(t.document.canvasNode[0]);return o===re||c(o)?t.gobj:null};var Se=new a("style");Se.cancelOnExit=!1,Se.defaultColor={row:0,column:1},Se.defaultPointStyle=2,Se.defaultLineThickness=2,Se.defaultLineStyle=0;var Pe=new a("visibility"),ke=new a("label");ke.labelPoolSaved=!1,ke.touchPos=GSP.GeometricPoint(0,0),ke.textRule=null;var $e=new a("trace"),Ce=new a("delete"),Le=[Se,$e,ke,Pe,Ce];return a.prototype.postProcessSketch=function(e){return ue&&ue.postProcessGobj&&(e.sQuery("*").each(ue.postProcessGobj),e.isDirty=!0),!0},Se.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,$("#wStylePane").css("display","block"),!0):!1},Se.deactivate=function(){Object.getPrototypeOf(this).deactivate(this),$("#wStylePane").css("display","none"),this.cancelOnExit=!1,w(null)},Se.postProcessGobj=function(e,t){t.oldStyle&&(Se.cancelOnExit&&(t.style=jQuery.extend(!0,{},t.oldStyle),k(),t.sQuery.sketch.invalidateAppearance(t)),delete t.oldStyle),Object.getPrototypeOf(Se).postProcessGobj(e,t)},Se.handleTap=function(e,t){var n;n=Object.getPrototypeOf(Se).handleTap(e,t),n&&(w(n),n.oldStyle||(n.oldStyle=jQuery.extend(!0,{},n.style)),T(he),O(be,ge),me>=0&&x(me))},Pe.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?($("#wVisibilityPrompt").css("display","block"),!0):!1},Pe.deactivate=function(){$("#wVisibilityPrompt").css("display","none"),Object.getPrototypeOf(this).deactivate(this)},Pe.preProcessGobj=function(e,t){t.style.hidden&&(t.show(),t.sQuery.sketch.constrainAndRedraw(),W(t)),Object.getPrototypeOf(Pe).preProcessGobj(e,t)},Pe.postProcessGobj=function(e,t){var n=t.style;n.faded&&(t.hide(),G(t)),R(t),Object.getPrototypeOf(Pe).postProcessGobj(e,t)},Pe.handleTap=function(e,t){var n=Object.getPrototypeOf(Pe).handleTap(e,t);n&&(n.style.faded?G(n):W(n),$("#wVisibilityPrompt").css("display","none"))},Pe.setVisColor=function(e){var t="rgb(192,192,192)",n=e.preferences.colorableComponents.Background.color;if(n){var o=document.createElement("div");o.style.color=n;var a=window.getComputedStyle(o).color;if("rgb"===a.substring(0,3)){var i=a.split("(")[1].split(")")[0];i=i.split(","),t="rgb(";for(var l=0;3>l;l++)t+=i[l]<128?i[l]+64:i[l]-32,2>l&&(t+=",");t+=")"}}Pe.visColor=t},ke.cacheProperties=function(e){this.oldLabel="Caption"===e.genus?e.textMFS:e.label,this.oldAutoGenerate=e.shouldAutogenerateLabel,A(e),this.oldStyle=$.extend(!0,{},e.style)},ke.emptyCache=function(){this.oldLabel=null,this.oldStyle=null},ke.clear=function(e){this.emptyCache(),D(),M(""),$("#measureButtons, #transImageButtons, #paramButtons").toggle(!1),e!==!1&&(ke.sizeElt.val(""),ke.fontElt.val(""),ke.showLabelElt.prop("checked",!1))},ke.finalizeLabel=function(){var e;de&&de.hasLabel&&de.style.nameOrigin&&(e=LabelControls.originFromText(de.label),e&&de.style.nameOrigin!==e&&(de.style.nameOrigin=e))},ke.restoreLabel=function(e){e&&(e.style&&(e.style=$.extend(!0,{},ke.oldStyle)),"Caption"===e.genus?(e.textMFS=ke.oldLabel,delete e.label):ke.oldLabel?(e.label=ke.oldLabel?"":" ",K(ke.oldLabel,e.style.nameOrigin),e.shouldAutogenerateLabel=ke.oldAutoGenerate):(delete e.label,e.shouldAutogenerateLabel=ke.oldAutoGenerate),N(),z(e)),this.emptyCache()},ke.handleTap=function(e,t){function n(){function e(){function e(){function e(e){var t={init:!0};return(r.style.nameOrigin===e||!l.label&&"namedFromLabel"!==r.style.nameOrigin)&&(t.create=!0),r.makeParentalLabel(e,t)}var t,n,o,l;(r.isTransformationConstraint||r.state.labelParent)&&(l=r.isTransformationConstraint?r.parents.source:r.state.labelParent,t=e("namedByPrime"),n=e("namedByShortFn"),o=e("namedByFullFn")),i[t]="namedByPrime",i[n]="namedByShortFn",i[o]="namedByFullFn",i["*"]=r.label?"namedFromLabel":"namedByPrime",a.namedByPrime=t,a.namedByShortFn=n,a.namedByFullFn=o,a.namedFromLabel=r.label?r.label:t,r.label?r.style.nameOrigin=i[r.label]||"namedFromLabel":(r.label=t,r.style.nameOrigin="namedByPrime")}function t(){a={namedFromTemplate:"",noVisibleName:"",namedFromLabel:"*"},i={" ":"noVisibleName","*":"namedFromLabel"}}var n,o=ke.nameClass,a={},i={};if(n=f&&U(d)===o?d:r,$(".wLabelRadios").toggle(!1),o){switch($("#"+o+"Buttons").toggle(!0),o){case"transImage":e(),ke.handleTap&&n&&U(n)===o&&"namedFromLabel"!==n.style.nameOrigin&&(r.style.nameOrigin=n.style.nameOrigin);break;case"measure":case"param":t();break;default:console.log("Unknown nameClass: "+o)}LabelControls.init(o,de,WIDGETS.controlCallback,a,i,"#wLabelEditText","#"+o+"Buttons input[type='radio']","#wLabelShow")}else LabelControls.terminate()}function t(){var e=s.val();e&&ke.setFontSize(e),e=c.val(),e&&ke.setFont(e)}function n(e){var t,n=!1;for(t=0;t<c[0].length;t++)if(c[0][t].innerText===e){c[0].selectedIndex=t,n=!0;break}return n}function o(e,t){var n,o,a,i=$("#wLabelFont optgroup"),l="<option value='"+e+"'>"+t+"</option>",r=i.filter('[label="Sans Serif"]'),s=i.filter('[label="Serif"]'),d=i.filter('[label="Mono-spaced"]'),u=i.filter('[label="Other"]'),f=!1;for(o=e.search(/sans-serif/i)?r:e.search(/serif/i)?s:e.search(/monospace/i)?d:u.length?u:c.append('<optgroup label="Other"></optgroup>'),a=$(o).find("option"),n=0;n<a.length;n++)if(-1===t.localeCompare(a[n].innerText)){$(a[n]).before($(l)),f=!0;break}f||o.append(l)}function a(){var e=X(de),t=e["font-size"];if(s.val(t),c[0].selectedIndex=-1,t=Y(de,!1),!t)throw GSP.createError("WIDGETS.copyGObjToStyles() found a gobj without a font family.");n(t)||(o(e["font-family"],t),n(t))}function i(e,t){var n;return n=e&&t&&e.hasLabel===t.hasLabel,n=n&&(t.hasLabel||e.kind===t.kind||e.isOfKind("Measure")&&t.isOfKind("Measure")),n=n&&(ke.isTap||!t.hasLabel||!t.style.label.showLabel)}function l(){var e,t=u.textMFS,n=t.match(/<T\'[^\'\r\n]+\'>/g),o="";for(e=0;e<n.length;e++)o&&(o+=" "),o+=n[e].replace(/<T\'([^\'\r\n]+)\'>/,"$1");return o}var r,d,f,p;p=!1,"Caption"!==u.genus||u.label?"CompositeText"===u.genus&&(p=!0):u.label=l(),$("#wLabelEditText").prop("disabled",p),$("#wLabelEditLabel").prop("disabled",p),u.hasLabel||u.style.nameOrigin?$("#wShowLabelButton label").show():$("#wShowLabelButton label").hide(),r=u,d=de,f=i(d,r),ke.clear(!1),de&&de.setRenderState("none"),u.setRenderState("targetHighlit"),this.prevGobj=de,de=u,ke.nameClass=U(de),ke.cacheProperties(de),r.hasLabel&&!r.style.label.showLabel&&(r.labelRenderBounds=H(r.sQuery.sketch.renderRefCon.labelBounds[r.id])),M(de.label),f?t():a(),e()}function o(){r.prop("disabled",!1),J(!0),r.prop("checked",!0)}function a(){var e=de.style.nameOrigin,t=de.isOfKind("Button"),n="measure"===ke.nameClass||"param"===ke.nameClass,o=t||"undefined"==typeof e,a=o||"namedFromLabel"===e;t?(r.prop("checked",a),r.prop("disabled",o)):n&&($("#wLabelPane .radio-inline input").prop("checked",!1),$("#wLabelPane .radio-inline input[value='"+e+"']").prop("checked",!0),r.prop("checked","noVisibleName"!==e),r.prop("disabled",!1))}function i(e){var t=e.match(/<VL<T\'.*\'>>/);return t||(t=e.match(/<T\'.*\'>/)),t?!0:!1}var l=ke.inputElt,r=ke.showLabelElt,s=ke.sizeElt,c=ke.fontElt,d=GSP.GeometricPoint(t.position.x,t.position.y),u=Object.getPrototypeOf(ke).handleTap(e,t);if(ke.touchPos=d,ke.isTap=!0,"Caption"!==u.genus||i(u.textMFS)){if(V(),u===de)return de.hasLabel&&(J(),M(de.label)),void(ke.isTap=!1);ke.finalizeLabel(),n(),de.hasLabel?o():a(),l.on("keyup",function(e){if(e.stopPropagation(),13===e.keyCode)ke.confirmLabel(!0);else{var t=l.val();t.length>0?K(t):de.isOfKind("Button")&&M(" ")}}),ke.isTap=!1}},ke.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,de=null,this.prevGobj=null,$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","block"),this.inputElt||(this.inputElt=$("#wLabelEditText"),this.showLabelElt=$("#wLabelShow"),this.sizeElt=$("#wLabelFontSize"),this.fontElt=$("#wLabelFont")),this.inputElt.on("click",function(){$(this).focus()}),this.clear(),!0):!1},ke.deactivate=function(){de&&(de.setRenderState("none"),this.cancelOnExit&&this.restoreLabel(de)),this.clear(),Object.getPrototypeOf(this).deactivate(this),$("#wLabelContent").css("display","none"),$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","none"),this.cancelOnExit=!1},ke.confirmLabel=function(e){this.finalizeLabel(),e?this.deactivate():this.clear()},ke.setFontSize=function(e){var t=X(de);e=+e,t["font-size"]!==e&&(t["font-size"]=e,z(de))},ke.setFont=function(e){var t=X(de),n=t["font-family"];n!==e&&(t["font-family"]=e,z(de))},ke.postProcessSketch=function(e){ke.clear(),$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","block"),de=null,Object.getPrototypeOf(ke).postProcessSketch(e)},$e.revealTracedGobjs=function(e){var n=e?"unmatchedGiven":"none";t().sQuery("*").each(function(e,t){t.style.traced&&!t.style.hidden&&t.setRenderState(n)})},$e.setGlowing=function(){function e(){$e.revealTracedGobjs(!0)}function t(){$e.revealTracedGobjs(!1)}var n=$e.glowBox.checked;n?(se.on("StartDrag.WSP",t),se.on("EndDrag.WSP",e),se.on("StartAnimate.WSP",t),se.on("EndAnimate.WSP",e),se.on("StartMove.WSP",t),se.on("EndMove.WSP",e)):te(),$e.revealTracedGobjs(n)},$e.toggleEnabling=function(e){var n=void 0!==e?e:$("#wTraceEnabled")[0].checked;t().preferences.tracesEnabled=n,$("#wTraceEnabled").prop("checked",n),$("#wTracePrompt").css("display","none")},$e.toggleFading=function(){var e=t(),n=e.preferences,o=$("#wTraceFading")[0].checked;n.fadeTraces=o,o?(e.traces.fadeStartTime=Date.now(),e.startFadeJob()):e.stopFadeJob(),$("#wTracePrompt").css("display","none")},$e.activate=function(e){return $e.glowBox=$("#wTracesGlowing")[0],Object.getPrototypeOf(this).activate(e,this)?($("#wTracePrompt").css("display","block"),$("#wTraceEnabled").prop("checked",t().preferences.tracesEnabled),$("#wTraceFading").prop("checked",t().preferences.fadeTraces),this.cancelOnExit=!1,$("#wTracePane").css("display","block"),$e.setGlowing(),$e.autoEnabled=!1,!0):!1},$e.deactivate=function(){$e.glowBox.checked&&($e.glowBox.checked=!1,$e.setGlowing(),$e.glowBox.checked=!0),Object.getPrototypeOf(this).deactivate(this),$("#wTracePane").css("display","none"),this.cancelOnExit=!1},$e.signalChangedTraceState=function(e){function n(){var e=t().canvasNode.css("backgroundColor"),n=e.match(/rgba\(.*,.*,.*,\s*(.*)\)/);return n&&n[1]&&"0"===n[1]?"white":e}var o=e.state.renderState,a=e.style.color;e.style.traced?(e.setRenderState("targetHighlit"),setTimeout(function(){e.setRenderState(o)},500)):e.isOfKind("Point")?(e.hide(),setTimeout(function(){e.show()},500)):(e.style.color=n(),e.style.width&&(e.style.width+=1),e.invalidateAppearance(),setTimeout(function(){e.style.color=a,e.style.width&&(e.style.width-=1),e.invalidateAppearance()},500))},$e.handleTap=function(e,t){var n,o=Object.getPrototypeOf($e).handleTap(e,t);ee(o)&&o&&(n=o.style,n.traced=!n.traced,n.traced?($e.autoEnabled||($e.toggleEnabling(!0),$e.autoEnabled=!0),$e.glowBox.checked&&o.setRenderState("unmatchedGiven")):o.setRenderState("none"),$("#wTracePrompt").css("display","none"),$e.glowBox.checked||$e.signalChangedTraceState(o))},Ce.deleteProgeny=function(){var e,n=t(),o=n.document.getRecentChangesDelta();n.gobjList.removeGObjects(Ce.progenyList,n),e=n.document.pushConfirmedSketchOpDelta(o),n.document.changedUIMode(),this.sketch.event("DeleteGObjs",{},{"deleted gobjs":Ce.progenyList,delta:e})},Ce.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,$("#wDeletePrompt").css("display","block"),!0):!1},Ce.deactivate=function(){Object.getPrototypeOf(this).deactivate(this),$("#wDeletePrompt").css("display","none"),this.cancelOnExit=!1},Ce.handleTap=function(e,t){var n=Object.getPrototypeOf(Ce).handleTap(e,t),o=$("#delete-confirm-modal"),a=o.find(".util-popup-content");n&&(oe(n),o.css("display","block"),a.tinyDraggable({exclude:".dragExclude"}),$("#deleteCancel").focus())},Ce.deleteConfirm=function(){$("#delete-confirm-modal").css("display","none"),Ce.deleteProgeny(),delete Ce.progenyList},Ce.deleteCancel=function(){$("#delete-confirm-modal").css("display","none"),ne(Ce.progenyList,"none"),delete Ce.progenyList},{initWidget:function(){ae=q(),$.ajax({url:ae+"widgets.html",success:function(e){$("#widget")&&$("#widget").remove(),$("body").append(e),le=$("<div style='position: relative; height:0; width:100%;'></div>"),$("body").append(le),ie=$("#widget"),ie.detach(),le.append(ie),ie.css("display","none"),r(),$("#widget img").attr("src",function(e,t){var n=t.match(/[^\/]+$/);return ae+n})},dataType:"html"})},showWidgets:function(e,n){if(!ie)throw GSP.createError("showWidgets called before loading $widget.");return e?(n&&c(n),void((re||!e)&&(e?(i(),fe&&(fe.activate(t(),fe),fe=null)):(ue&&(fe=ue,ue.deactivate()),l())))):void ie.css("display","none")},relatedSketchNode:function(e,t){for(var n=$(e),o=n.filter(t);n.length&&!o.length;)o=n.prevAll(t),n=n.parent();if(!o.length)throw GSP.createError("relatedSketchNode() couldn't find the target: "+t);return o[0]},toggleWidgets:function(e){var t="none"===ie.css("display"),n=WIDGETS.relatedSketchNode(e,".sketch_canvas");if(!n)throw GSP.createError("toggleWidgets called for an element that's neither a sketch_canvas nor a widget_button");return n!==re&&(t=!0),WIDGETS.showWidgets(t,n),t},confirmModality:function(){ue&&(ue.cancelOnExit=!1,ue.deactivate())},cancelModality:function(){ue&&(ue.cancelOnExit=!0,ue.deactivate())},toggleStyleModality:function(){ue===Se?Se.deactivate(this):Se.activate(t(),Se)},toggleVisibilityModality:function(){ue===Pe?Pe.deactivate(Pe):re&&se.data("document")&&Pe.activate(t(),Pe)},toggleLabelModality:function(){ue===ke?ke.deactivate(ke):re&&se.data("document")&&ke.activate(t(),ke)},toggleObjectModality:function(){ue===Ce?Ce.deactivate(Ce):re&&se.data("document")&&Ce.activate(t(),Ce)},toggleTraceModality:function(){ue===$e?$e.deactivate($e):re&&se.data("document")&&$e.activate(t(),$e)},setTraceGlowing:function(){$e.setGlowing(),$("#wTracePrompt").css("display","none")},toggleTraceFading:function(){$e.toggleFading()},toggleTraceEnabling:function(){$e.toggleEnabling()},clearTraces:function(){t().clearTraces(),$("#wTracePrompt").css("display","none")},pointCheckClicked:function(){F(0>he?Se.defaultPointStyle:-1)},pointGridClicked:function(e){var t=p();F(Math.floor(e.offsetY/(20*t)))},lineCheckClicked:function(){0>be&&0>ge?E(Se.defaultLineThickness,Se.defaultLineStyle):E(-1,-1)},lineGridClicked:function(e){var t=p();E(Math.floor(e.offsetY/(20*t)),Math.floor(e.offsetX/(51*t)))},colorCheckClicked:function(){var e=g(Se.objectColorBox);e||Se.textColorBox.checked?0>me&&j(Se.defaultColor.column,Se.defaultColor.row):j(-1,0)},labelCheckClicked:function(){var e=g(Se.textColorBox);e||Se.objectColorBox.checked?0>me&&j(Se.defaultColor.column,Se.defaultColor.row):j(-1,0)},labelSetFontSize:function(e){de&&ke.setFontSize(+e)},labelSetFont:function(e){de&&ke.setFont(e)},colorGridClicked:function(e){var t=p(),n=e.pageX-$("#widget_colorGrid").offset().left,o=e.pageY-$("#widget_colorGrid").offset().top,a=Math.min(8,Math.floor(n/(27.2*t))),i=Math.floor(o/(27*t));j(a,i)},labelChanged:function(e){LabelControls.labelChanged(e)||K(e)},controlCallback:function(e,t){return e=K(e,t)},labelToggled:function(){J(ke.showLabelElt.prop("checked"))},deleteConfirm:function(){Ce.deleteConfirm(this)},deleteCancel:function(){Ce.deleteCancel(this)},setWidgetsPrefs:function(e){PREF.setWebPagePrefs(e)},getScriptPath:function(){return ae},resizeSketchFrame:function(e){v(e)}}}(),LabelControls=function(){function e(e,t){var n={namedFromTemplate:o,namedFromLabel:a,noVisibleName:i},c={namedByPrime:l,namedByShortFn:r,namedByFullFn:s,namedFromLabel:a,noVisibleName:i};switch(e){case"measure":case"param":return n[t];case"transImage":return c[t]}}function t(t,n,o,a,i,l,r,s){this.mode=t,this.oldText=n.label,this.oldOrigin=n.style.nameOrigin,this.lastOrigin="",this.labelText=n.label,$(l).prop("value",n.label),
this.callback=o,this.textRule=a,this.originRule=i,this.radioSelector=r,this.inputSelector=l,this.showSelector=s,this.tappedGobj=n,this.radioPressed=function(t){var n,o,a=this.textRule[t],i=this.tappedGobj;"namedFromLabel"===t&&""===a&&(a=i.label),(t!==i.style.nameOrigin||a!==i.label)&&(n=e(this.mode,t),this.state=new n(this)),"namedFromLabel"===t&&(o=$(this.inputSelector)[0],o.focus(),o.setSelectionRange(0,o.value.length))},this.originFromText=function(e){var t;return""===e?t="noVisibleName":(t=this.originRule[e],t||(t="transImage"===this.mode?"namedFromLabel":this.originRule["*"])),t},this.labelChanged=function(t,n){var o=e(this.mode,n);this.labelText=t,this.state instanceof o?this.callback(t,n):this.state=new o(this)},this.state=null}function n(e){this.nameOrigin=e,this.init=function(t,n,o){var a,i=n,l="noVisibleName"===e&&"transImage"===t.mode;this.machine=t,e!==t.lastOrigin&&(i=t.callback(n,e)),""!==n&&$(t.inputSelector).val(i),a=$(this.machine.radioSelector+"[value="+e+"]"),a.prop("checked")||a.prop("checked",!0),l?$(t.radioSelector).prop("checked",!1):i!==n&&(this.machine.labelText=i,delete this.machine.originRule[n],this.machine.originRule[i]=e,this.machine.textRule[e]=i),$(t.showSelector).prop("checked",o),t.lastOrigin=e}}function o(e){this.init(e,"",!0)}function a(e){this.init(e,e.labelText,!0)}function i(e){this.init(e,"",!1),WIDGETS.labelToggled()}function l(e){this.init(e,e.textRule.namedByPrime,!0)}function r(e){this.init(e,e.textRule.namedByShortFn,!0)}function s(e){this.init(e,e.textRule.namedByFullFn,!0)}var c;return o.prototype=new n("namedFromTemplate"),o.prototype.constructor=o,a.prototype=new n("namedFromLabel"),a.prototype.constructor=a,i.prototype=new n("noVisibleName"),i.prototype.constructor=i,l.prototype=new n("namedByPrime"),l.prototype.constructor=l,r.prototype=new n("namedByShortFn"),r.prototype.constructor=r,s.prototype=new n("namedByFullFn"),s.prototype.constructor=s,{init:function(n,o,a,i,l,r,s,d){var u=e(n,o.style.nameOrigin);c=new t(n,o,a,i,l,r,s,d),c.state=new u(c),$(".wLabelRadios label").click(function(e){LabelControls.transition(e)})},terminate:function(){c&&(c=null)},transition:function(e){var t=e.target.value||e.target.children[0].value;t&&c.radioPressed(t)},labelChanged:function(e){return c?(c.labelChanged(e,this.originFromText(e)),!0):!1},originFromText:function(e){return c?c.originFromText(e):null}}}(),PAGENUM=function(){function e(e,t){return $(e).parent().find(t)}function t(e){return $(e).data("document")}function n(e){function t(e){if(!Number.isInteger(e))throw GSP.createError("bad argument to setToolEnabling enableThisPage.");o.addClass("p_"+e)}var n,o,a,i,l=e.canvasNode[0],r=$(l).find("div.wsp-tool");for(n=0;n<r.length;n++)o=$(r[n]),a=o.find("[title]").attr("title"),a||(a=o[0].textContent),a&&(a=a.replace(/\s+/g,""),i=PREF.getPref(e,a,"tool"),i&&"all"!==i[0]&&(o.addClass("page_toggle"),"none"!==i[0]&&i.forEach(t)))}function o(t){var n,o,a=t.canvasNode[0],i=e(a,".page_buttons"),l=e(a,".button_area"),r=PREF.getPref(t,"pagecontrol"),d=PREF.getPref(t,"resetbutton"),u=PREF.getPref(t,"wsplogo");1===i.length&&r&&(t.docSpec.pages.length<2?(i.removeClass("page_buttonsActive"),i.empty()):(n='<span class="page_btn page_prevBtn">&nbsp;</span><div style="display:inline-block; position:relative;"><span class="page_num"></span></div><span class="page_btn page_nextBtn">&nbsp;</span></span>',i.html(n),i.addClass("page_buttonsActive"),i.find(".page_num").on("click",{node:a},function(e){return c(e.data.node),!1}),i.find(".page_prevBtn").on("click",{node:a},function(e){return s(e.data.node,-1,!0),!1}),i.find(".page_nextBtn").on("click",{node:a},function(e){return s(e.data.node,1,!0),!1}),s(a,+t.metadata["start-page"]))),1===l.length&&(d.length&&"none"!==d[0]&&(n='<button class="reset_button',"all"!==d[0]&&(n+=" page_toggle",d.forEach(function(e){n+=" p_"+e})),n+='" onclick="PAGENUM.undoAll(this);">Reset</button>',l.append(n)),u&&(n='<div class="wsp_logo"></div>',o=l.find(".util-menu-btn"),o.length>0?o.after(n):l.prepend(n)))}function a(e){var t=e.focusPage.metadata.id,n=$(e.canvasNode).parent().find(".page_popupNum");n.length>0&&($(n).css("background-color","#fff"),$(n[t-1]).css("background-color","#ccc"))}function i(e,t){var n=$(e).closest(".sketch_container").find(".page_toggle");n.length&&(n.hide(),n.filter(".p_"+t).show())}function l(e,t){var n=e.focusPage,o=n.metadata.id,l=e.docSpec.pages.length,r=$(e.canvasNode).parent().find(".page_buttons");u&&n.restoreTraces(),r&&(r.find(".page_num").html("&nbsp;"+o+"&nbsp;"),r.find(".page_nextBtn").css("opacity",l>o?"1":"0.4"),r.find(".page_prevBtn").css("opacity",o>1?"1":"0.4"),a(e)),i(t,o)}function r(){var e=$(".sketch_canvas");e.on("LoadDocument.WSP",function(e,t){o(t.document),n(t.document)}),e.on("DidChangeCurrentPage.WSP",function(e,t){l(t.document,e.target)})}function s(e,n,o){var a=t(e),i=a.focusPage,l=+a.focusPage.metadata.id;o&&(n+=l),n>0&&n<=a.docSpec.pages.length&&n!==l&&(u&&!i.preferences.fadeTraces&&i.saveTraces(),a.switchPage(n))}function c(n){function o(e){return'<span class="page_popupNum">&nbsp;'+e+"&nbsp;</span>"}var i=e(n,".page_buttons");if(i.find(".page_popup").length>0)return void d(n);for(var l=t(n),r=l.docSpec.pages.length,c=o(1),u=2;r>=u;u+=1)c+="<br>"+o(u);var f=$.parseHTML('<div class="page_popup" style="line-height:1.1rem;">'+c+"</div>");i.find(".page_num").after(f[0]);var p=$(f).outerHeight()+1;$(f).css({top:-p+"px"}),a(l),i.find(".page_popupNum").on("mouseover",{node:n},function(e){s(e.data.node,this.innerText.trim())}),i.find(".page_popupNum").on("click",{node:n},function(e){return s(e.data.node,this.innerText.trim()),d(e.data.node),!1}),$(window).one("click",{node:n},function(e){return $(e.target).hasClass("page_num")?void 0:(d(e.data.node),!1)}),$(window).off("keydown"),$(window).on("keydown",{node:n},function(e){var t=e.which;return t>=37&&40>=t?(38>=t?s(e.data.node,-1,!0):s(e.data.node,1,!0),!1):void 0})}function d(t){var n=e(t,".page_buttons");n.find(".page_popupNum").off("mouseover"),n.find(".page_popupNum").off("click"),n.find(".page_popup").remove(),$(window).off("keydown")}var u=!0;return{initPageControls:function(){r()},undoAll:function(e){var n=WIDGETS.relatedSketchNode(e,".sketch_canvas");t(n).undo("all")}}}(),UTILMENU=function(){function e(e){function t(e){r.find(e).show(),c++}var n,o,a,i=PREF.getPref(e,"upload","util"),l=PREF.getPref(e,"download","util"),r=$(e.canvasNode).parent().find(".util-menu-btn"),s=i||l,c=0;s?(r.show(),$(r.find(".util-menu-item")).hide(),i&&t(".util-upload"),l&&t(".util-download"),n=r.find(".util-menu-content"),o=.25+1.45*c,a=-o-.4,n.css("height",o+"rem"),n.css("top",a+"rem")):r.hide()}function t(){$(".util-menu-content").hide(),$(window).off("click",n)}function n(e){return $(e.target).hasClass("util-menu")?void 0:(t(),!1)}function o(e,t){var n,o,a,i=e.pageData;if($("#util-fname")[0].validity.valid){".json"!==t.slice(-5)&&(t+=".json");var l=$("#downloadLink")[0];$.each(e.docSpec.pages,function(e,t){var n=t.metadata.id;i[n].session.traceData&&(t.traceData=i[n].session.traceData)}),n=e.sQuery().getSketchJSON(),o=new Blob([n],{type:"text/plain"}),a=URL.createObjectURL(o),l.href=a,l.download=t,l.click(),s(e),UTILMENU.closeModal("download-modal","save")}}function a(){var e=$("#download-modal");e.css("display","block"),e.find(".util-popup-content").tinyDraggable({exclude:".dragExclude"}),$("#util-fname").select()}function i(){t(),$("#upload-modal").data("sketchNode",u),$("#file-name-input").attr("onchange","UTILMENU.loadSketch(this.files[0]);")}function l(){function e(){o($(u).data("document"),$("#util-fname")[0].value)}t(),$("#download-modal").data("sketchNode",u);var n=$("#downloadOK");n.focus(),n.on("click",function(){e()}),$("#util-fname").on("keyup",function(t){var n=$("#util-fname")[0].validity.valid;27===t.keyCode?UTILMENU.closeModal("download-modal","cancel"):13===t.keyCode&&n&&e()})}function r(e){var t,n=$("#upload-modal");u=e,t=c(e)&&PREF.shouldEnableForCurrentPage("util","download",$(e).data("document").focusPage),i(),t?(l(),n.css("display","block"),n.find(".util-popup-content").tinyDraggable({exclude:".dragExclude"}),$("#downloadBeforeUpload").focus(),n.on("keyup",function(e){27===e.keyCode&&UTILMENU.closeModal("upload-modal","cancel")})):$("#file-name-input").click()}function s(e){var t=e.canvasNode[0].id,n=b64_md5(JSON.stringify(e.getCurrentSpecObject()));$("#"+t).data("prevChecksum",n)}function c(e){var t=$(e).data("document"),n=t.getCurrentSpecObject(),o=b64_md5(JSON.stringify(n)),a=$(e).data("prevChecksum");return o!==a}function d(e){function t(e){return e&&e.includes("Times")&&e.includes("sans-serif")&&(e=e.replace("sans-serif","serif")),e}function n(e){var n;for(n=0;n<e.length;++n)e[n]=t(e[n])}function o(e){$.each(e,function(e,n){var o=n["font-family"];o?n["font-family"]=t(o):n.label&&(o=n.label["font-family"],o&&(n.label["font-family"]=t(o)))})}function a(e){n(e.resources.fontList),e.pageData?$.each(e.pageData,function(e,t){o(t.spec.preferences.text.textTypes)}):$.each(e.pages,function(e,t){o(t.preferences.text.textTypes)})}var i=['"Times New Roman", serif','"Arial", sans-serif'];e.resources?e.resources.fontList?a(e):e.resources.fontList=i:e.resources={fontList:i},e.docSpec.resources?e.docSpec.resources.fontList?a(e.docSpec):e.docSpec.resources.fontList=i:e.docSpec.resources={fontList:i},o(e.focusPage.preferences.text.textTypes),s(e)}var u;return{checkFName:function(e){$("#downloadOK").prop("disabled",!e.valid)},closeModal:function(e,t){if($("#"+e).css("display","none"),"download-modal"===e)$("#util-fname").off("keyup"),$("#downloadOK").off("click");else if("upload-modal"===e)switch(t){case"save":a($(this).parents(".util-menu-btn"));break;case"dont-save":$("#file-name-input").click()}},download:function(e){u=WIDGETS.relatedSketchNode(e.target,".sketch_canvas"),$("#download-modal").data("callSave")&&$("#download-modal").removeData("callSave"),l(u),a()},loadSketch:function(e){var t=new FileReader,n=$(u);t.onload=function(t){n.data("sourceDocument",t.target.result),n.data("fileName",e.name.replace(".json","")),n.WSP("loadSketch"),n.removeData("sourceDocument"),WIDGETS.showWidgets(!0,n[0])},t.readAsText(e)},upload:function(e){r(WIDGETS.relatedSketchNode(e.target,".sketch_canvas"))},menuBtnClicked:function(e){var t=$(e.parentNode).find(".util-menu-content");t.toggle(),"block"===t.css("display")&&$(window).on("click",n)},addUtilMenu:function(e){var t=WIDGETS.getScriptPath(),n='<div class="util-menu-btn util-menu">';return n+='<img class = "util-menu" src="'+t+'utility-icon.png" onclick="UTILMENU.menuBtnClicked(this);" />',n+='<div class="util-menu-content util-menu">',n+='<div class="util-menu-item util-menu util-download" onclick="UTILMENU.download(event)">Download...</div>',n+='<div class="util-menu-item util-menu util-upload" onclick="UTILMENU.upload(event);">Upload...</div>',n+="</div>",n+="</div>",e.replaceWith(n),n},initUtils:function(){var t=$(".sketch_canvas");t.on("LoadDocument.WSP",function(t,n){d(n.document),e(n.document)}),$.each(t,function(e,t){var n=$(t).parent(),o=n.find(".util-menu-btn"),a=$(t).data("document");1!==o.length||o[0].firstElementChild||UTILMENU.addUtilMenu(o),a&&d(a)})}}}();$(function(){WIDGETS.initWidget(),PAGENUM.initPageControls(),UTILMENU.initUtils()});